<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{app.title}">BMImpact</title>
    <link rel="icon" type="image/svg+xml" href="/images/logo.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/theme.js" defer></script>
    <script src="/js/charts.js" defer></script>
</head>
<body>
<div class="container">
    <div class="header-nav">
        <a href="/" class="brand-container">
            <img src="/images/logo.svg" alt="BMImpact Logo" class="logo">
            <h1 style="margin: 0; font-size: 1.5rem;" th:text="#{app.title}">BMImpact</h1>
        </a>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="?lang=pl" style="font-size: 0.9rem;">PL</a>
            <span style="color: var(--border-color);">|</span>
            <a href="?lang=en" style="font-size: 0.9rem;">EN</a>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </div>

    <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
        <span sec:authorize="isAuthenticated()">
            <span th:text="#{auth.welcome}" style="color: var(--text-secondary);">Welcome,</span>
            <a href="/profile" style="font-weight: 700; color: var(--text-primary);">
                <span sec:authentication="name">User</span>
            </a>
            <form th:action="@{/logout}" method="post" style="display: inline; margin-left: 10px;">
                <button type="submit" style="width: auto; margin-bottom: 0; padding: 5px 15px; font-size: 0.9rem;">
                    <span th:text="#{auth.button.logout}">Logout</span>
                </button>
            </form>
        </span>
        <span sec:authorize="!isAuthenticated()">
            <a href="/login" th:text="#{auth.button.login}" style="margin-right: 10px;">Login</a>
            <a href="/register" th:text="#{auth.button.register}" style="padding: 5px 10px; background: var(--primary-color); color: white; border-radius: 4px; text-decoration: none;">Register</a>
        </span>
    </div>

    <div th:if="${calculatedResult}" class="result-box"
         th:classappend="${calculatedResult.category != null} ? ${calculatedResult.category.cssClass} : ''">

        <h2 style="margin-top: 0; border: none; font-size: 1.5rem;" th:text="#{result.title}">Your Result</h2>

        <div style="font-size: 2.5rem; font-weight: 800; margin: 10px 0;">
            <span th:text="${calculatedResult.bmi}">22.0</span>
        </div>
        <div style="font-size: 1.2rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem;">
            <span th:text="${calculatedResult.category != null} ? #{${'enum.category.' + calculatedResult.category.name().toLowerCase()}} : '-'">Normal</span>
        </div>

        <div th:if="${calculatedResult.category != null}" style="text-align: left; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <p style="margin-top: 0; font-style: italic;">
                <span th:text="#{${'result.description.' + calculatedResult.category.name().toLowerCase()}}">Description</span>
            </p>
            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">
            <p style="margin-bottom: 0;">
                <strong th:text="#{label.recommendation}" style="color: var(--primary-color);">Recommendation:</strong>
                <span th:text="#{${'result.recommendation.' + calculatedResult.category.name().toLowerCase()}}">Recommendation text</span>
            </p>
        </div>

        <p sec:authorize="!isAuthenticated()" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 1rem;">
            <i th:text="#{auth.link.login}">Log in to save this result to history.</i>
        </p>
    </div>

    <form th:action="@{/calculate}" method="post" th:object="${bmiForm}">
        <div class="form-group" style="display: flex; gap: 1rem; align-items: center; justify-content: center; background: var(--input-bg); padding: 10px; border-radius: var(--radius);">
            <div th:each="system : ${T(com.github.konradcz2001.bmimpact.model.UnitSystem).values()}">
                <input type="radio" th:field="*{unitSystem}" th:value="${system}" required style="width: auto; margin-bottom: 0;">
                <label th:for="${#ids.prev('unitSystem')}"
                       th:text="#{${'enum.unit.' + system.name().toLowerCase()}}"
                       style="display: inline; margin-bottom: 0; cursor: pointer;">
                </label>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label for="height" th:text="#{label.height}">Height:</label>
                <input type="number" id="height" name="height" step="1" th:field="*{height}" required placeholder="e.g. 180">
                <span th:if="${#fields.hasErrors('height')}" th:errors="*{height}" class="error"></span>
            </div>
            <div>
                <label for="weight" th:text="#{label.weight}">Weight:</label>
                <input type="number" id="weight" name="weight" step="1" th:field="*{weight}" required placeholder="e.g. 75">
                <span th:if="${#fields.hasErrors('weight')}" th:errors="*{weight}" class="error"></span>
            </div>
        </div>

        <button type="submit" th:text="#{button.calculate}" style="margin-top: 1rem;">Calculate BMI</button>
    </form>

    <h2 th:text="#{history.title}">BMI History</h2>

    <div th:if="${bmiPage != null and bmiPage.hasContent()}" style="margin-bottom: 2rem; padding: 1rem; background: var(--input-bg); border-radius: var(--radius); border: 1px solid var(--border-color);">
        <h3 th:text="#{chart.title}" style="margin-top: 0; font-size: 1.1rem; text-align: center;">Weight Progress</h3>
        <canvas id="bmiChart" width="400" height="200"></canvas>
    </div>

    <script th:inline="javascript" th:if="${bmiPage != null and bmiPage.hasContent()}">
        /*<![CDATA[*/
        const bmiHistoryData = [
            /*[# th:each="result : ${bmiPage.content}"]*/
            {
                date: /*[[${#dates.format(result.timestamp, 'yyyy-MM-dd HH:mm')}]]*/ '2023-01-01 12:00',
                weight: /*[[${result.weight}]]*/ 75,
                bmi: /*[[${result.bmi}]]*/ 22.5
            },
            /*[/]*/
        ];

        const chartLabels = {
            weight: /*[[#{chart.label.weight}]]*/ 'Weight',
            bmi: /*[[#{chart.label.bmi}]]*/ 'BMI'
        };
        /*]]>*/
    </script>

    <div style="overflow-x: auto;">
        <table th:if="${bmiPage != null and bmiPage.hasContent()}">
            <thead>
            <tr>
                <th th:text="#{table.header.height}">Height</th>
                <th th:text="#{table.header.weight}">Weight</th>
                <th th:text="#{table.header.bmi}">BMI</th>
                <th th:text="#{table.header.category}">Category</th>
                <th th:text="#{table.header.date}">Date</th>
                <th th:text="#{table.header.action}" style="text-align: center;">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="bmiResult : ${bmiPage.content}" style="border-left: 4px solid transparent;"
                th:classappend="${bmiResult.category != null} ? ${bmiResult.category.cssClass} : ''">
                <td th:text="${bmiResult.height}"></td>
                <td th:text="${bmiResult.weight}"></td>
                <td th:text="${bmiResult.bmi}" style="font-weight: bold;"></td>
                <td th:text="${bmiResult.category != null} ? #{${'enum.category.' + bmiResult.category.name().toLowerCase()}} : '-'"></td>
                <td th:text="${#dates.format(bmiResult.timestamp, 'dd-MM-yyyy HH:mm')}" style="color: var(--text-secondary); font-size: 0.85rem;"></td>
                <td style="text-align: center;">
                    <form th:action="@{/history/delete/{id}(id=${bmiResult.id})}" method="post"
                          onsubmit="return confirm(this.getAttribute('data-confirm'));"
                          th:attr="data-confirm=#{confirm.delete.history}"
                          style="margin: 0;">
                        <button type="submit" class="btn-small" th:text="#{button.delete}">Delete</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${bmiPage != null and bmiPage.totalPages > 1}" style="display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; gap: 10px;">
        <a th:if="${bmiPage.hasPrevious()}" th:href="@{/(page=${bmiPage.number - 1})}"
           style="padding: 5px 15px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--border-color);">&laquo;</a>

        <span style="font-size: 0.9rem; font-weight: 600;" th:text="${bmiPage.number + 1} + ' / ' + ${bmiPage.totalPages}">1 / 5</span>

        <a th:if="${bmiPage.hasNext()}" th:href="@{/(page=${bmiPage.number + 1})}"
           style="padding: 5px 15px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--border-color);">&raquo;</a>
    </div>

    <div th:if="${bmiPage == null or !bmiPage.hasContent()}" style="text-align: center; color: var(--text-muted); margin-top: 2rem; padding: 2rem; background: var(--input-bg); border-radius: var(--radius); border: 1px dashed var(--border-color);">
        <span sec:authorize="!isAuthenticated()" th:text="#{auth.link.login}">Please log in to see history.</span>
        <span sec:authorize="isAuthenticated()">No history yet. Calculate your first BMI!</span>
    </div>
</div>
</body>
</html>